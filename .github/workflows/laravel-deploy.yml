name: Deploy Laravel to EKS

on:
  push:
    branches:
      - main
      - cicd-with-eks

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  EKS_CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout repository
      - name: Checkout code
        uses: actions/checkout@v3

      # Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build Docker image
      - name: Build Docker image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/laravel-app:latest .

      # Push Docker image to Docker Hub
      - name: Push Docker image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/laravel-app:latest

      # Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # Update kubeconfig for EKS cluster
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region ${{ secrets.AWS_REGION }} \
            --name ${{ secrets.EKS_CLUSTER_NAME }}

      # Create Laravel secrets (if not exists)
      - name: Create Laravel secrets
        run: |
          if ! kubectl get secret laravel-secrets > /dev/null 2>&1; then
            kubectl create secret generic laravel-secrets \
              --from-literal=app-key=$(openssl rand -base64 32)
          fi


      # Deploy to EKS
      - name: Deploy to EKS
        run: |
          # Replace Docker image in deployment
          sed -i "s|YOUR_DOCKER_USERNAME|${{ secrets.DOCKER_USERNAME }}|g" k8s/deployment.yaml
          
          # Apply with zero-downtime strategy
          echo "Starting zero-downtime deployment..."
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          
          # Monitor the rollout with detailed information
          echo "Monitoring deployment progress..."
          kubectl rollout status deployment/laravel-app --timeout=600s --watch
          
          # Verify all pods are running
          echo "Deployment completed. Verifying pod status..."
          kubectl get pods -l app=laravel-app -o wide
          
          # Check service endpoints
          echo "Service endpoints:"
          kubectl get endpoints laravel-service
          
          echo "Zero-downtime deployment completed successfully!"