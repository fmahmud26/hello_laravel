name: Deploy Laravel to EKS

on:
  push:
    branches:
      - main
      - cicd-with-eks

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  EKS_CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout repository
      - name: Checkout code
        uses: actions/checkout@v3

      # Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Generate dynamic image tag (timestamp + commit SHA)
      - name: Generate image tag
        id: vars
        run: echo "TAG=$(date +%Y%m%d%H%M%S)-${GITHUB_SHA::7}" >> $GITHUB_ENV

      # Build Docker image with unique tag
      - name: Build Docker image
        run: |
          echo "Building image: ${{ secrets.DOCKER_USERNAME }}/laravel-app:${TAG}"
          docker build -t ${{ secrets.DOCKER_USERNAME }}/laravel-app:${TAG} .

      # Push versioned Docker image
      - name: Push Docker image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/laravel-app:${TAG}

      # Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # Update kubeconfig for EKS cluster
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region ${{ secrets.AWS_REGION }} \
            --name ${{ secrets.EKS_CLUSTER_NAME }}

      # Create Laravel secrets (if not exists)
      - name: Create Laravel secrets
        run: |
          if ! kubectl get secret laravel-secrets > /dev/null 2>&1; then
            kubectl create secret generic laravel-secrets \
              --from-literal=app-key=$(openssl rand -base64 32)
          fi

      # Deploy to EKS using dynamic tag
      - name: Deploy to EKS
        run: |
          echo "Deploying image: ${{ secrets.DOCKER_USERNAME }}/laravel-app:${TAG}"

          # Replace placeholders with actual Docker username and tag
          sed -i "s|YOUR_DOCKER_USERNAME|${{ secrets.DOCKER_USERNAME }}|g" k8s/deployment.yaml
          sed -i "s|:latest|:${TAG}|g" k8s/deployment.yaml

          echo "Applying Kubernetes manifests..."
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

          echo "Waiting for deployment rollout..."
          kubectl rollout status deployment/laravel-app --timeout=600s

          echo "âœ… Deployment successful! Checking resources..."
          kubectl get pods -l app=laravel-app -o wide
          kubectl get svc laravel-service
          kubectl get endpoints laravel-service

      # Auto-debug logs if rollout fails
      - name: Debug Pods on Failure
        if: failure()
        run: |
          echo "---- Describe Pods ----"
          kubectl describe pods -l app=laravel-app || true
          echo "---- Recent Logs ----"
          kubectl logs -l app=laravel-app --tail=100 --all-containers=true || true
